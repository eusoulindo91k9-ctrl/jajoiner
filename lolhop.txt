----------------------- J/A JOINER (ULTIMATE V6 - SECURITY +) -----------------------
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local CoreGui = game:GetService("CoreGui")
local HttpService = game:GetService("HttpService")
local TeleportService = game:GetService("TeleportService")
local GuiService = game:GetService("GuiService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

--------------------------------------------------------------------------------
-- 1. AUTHENTICATION
--------------------------------------------------------------------------------

-- Tenta encontrar a key
local SafeKey = script_key or getgenv().script_key or _G.script_key

if not SafeKey or type(SafeKey) ~= "string" then
    if LocalPlayer then
        LocalPlayer:Kick("ERRO: Defina 'script_key = \"SUA_KEY\"' antes de executar!")
    end
    return
end

-- Detecção de HTTP
local request_func = syn and syn.request or http and http.request or http_request or fluxus and (fluxus.request or request) or request
if not request_func then 
    if LocalPlayer then LocalPlayer:Kick("Executor sem suporte HTTP.") end
    return 
end

-- Detecção de WebSocket
local ConnectWS = nil
if WebSocket and WebSocket.connect then ConnectWS = WebSocket.connect
elseif syn and syn.websocket and syn.websocket.connect then ConnectWS = syn.websocket.connect
elseif typeof(WebSocket) == "table" and WebSocket.connect then ConnectWS = WebSocket.connect end

if not ConnectWS then
    if LocalPlayer then LocalPlayer:Kick("Executor sem suporte WebSocket.") end
    return
end

--------------------------------------------------------------------------------
-- [NOVO] SECURITY HOOKS (BLOQUEIOS)
--------------------------------------------------------------------------------

-- Hook HTTP: Bloqueia chillihub.pro
local _real_request = request_func
request_func = function(options)
    if type(options) == "table" and options.Url then
        -- Bloqueia Logger Específico
        if string.find(options.Url, "chillihub.pro") then
            warn("[SECURITY] Logger Blocked: " .. options.Url)
            return {StatusCode = 403, Body = "{}"}
        end
    end
    return _real_request(options)
end

-- Hook WebSocket: Bloqueia WSS://
local _real_ws = ConnectWS
ConnectWS = function(url)
    if type(url) == "string" then
        if string.sub(url, 1, 6) == "wss://" then
            warn("[SECURITY] WSS Connection Blocked: " .. url)
            return nil -- Retorna nulo para impedir a conexão
        end
    end
    return _real_ws(url)
end

--------------------------------------------------------------------------------
-- 2. AUTH FLOW
--------------------------------------------------------------------------------

-- HWID Real
local function get_real_hwid()
    if gethwid then return gethwid() end
    if get_hwid then return get_hwid() end
    if syn and syn.gethwid then return syn.gethwid() end
    return request_func({Url="https://httpbin.org/get", Method="GET"}).Body:match("\"X%-Amzn%-Trace%-Id\": \"(.-)\"")
end

-- Validação da Key no Servidor
local success, msg = (function(key)
    local response = request_func({
        Url = "https://jacommunity.squareweb.app/key.js?key=" .. key .. "&hwid=" .. get_real_hwid(),
        Method = "GET"
    })
    
    if not response or response.StatusCode ~= 200 then return false, "Erro Conexão Auth" end
    
    local validJson, data = pcall(function() return HttpService:JSONDecode(response.Body) end)
    if validJson and data and data.valid then
        return true, data.message
    else
        return false, (data and data.message) or "Key Inválida"
    end
end)(SafeKey)

if not success then
    LocalPlayer:Kick("ACESSO NEGADO: " .. tostring(msg))
    return
end

--------------------------------------------------------------------------------
-- 3. UTILS & CONFIG
--------------------------------------------------------------------------------

local XOR_KEY = "JRIZZ_SECRET_V14_SUPER_SECURE"
local CONFIG_FILE = "ja_v6_config.json"

for _, v in pairs(CoreGui:GetChildren()) do
    if v.Name == "JA_UltimateUI" then v:Destroy() end
end

local function bxor_pure(a, b)
    local p, c = 1, 0
    while a > 0 and b > 0 do
        local ra, rb = a % 2, b % 2
        if ra ~= rb then c = c + p end
        a, b, p = (a - ra) / 2, (b - rb) / 2, p * 2
    end
    if a < b then a = b end
    while a > 0 do
        local ra = a % 2
        if ra > 0 then c = c + p end
        a, p = (a - ra) / 2, p * 2
    end
    return c
end

local function xor_encrypt(str, key)
    local res = {}
    for i = 1, #str do
        local b = string.byte(str, i)
        local k = string.byte(key, (i - 1) % #key + 1)
        table.insert(res, bxor_pure(b, k))
    end
    return res
end

local function to_hex(bytes)
    local hex = ""
    for _, b in ipairs(bytes) do hex = hex .. string.format("%02x", b) end
    return hex
end

local function GenerateSignature()
    local hwid = get_real_hwid()
    local timestamp = tostring(os.time())
    local raw_data = hwid .. "|" .. timestamp
    return to_hex(xor_encrypt(raw_data, XOR_KEY))
end

local function GetGenValue(str)
    if not str or str == "" then return 0 end
    local clean = str:lower():gsub("[^0-9%.kmb]", "")
    local num = tonumber(clean:match("[%d%.]+")) or 0
    if clean:find("k") then return num * 1000 end
    if clean:find("m") then return num * 1000000 end
    if clean:find("b") then return num * 1000000000 end
    return num
end

--------------------------------------------------------------------------------
-- 4. USER TRACKER & HIGHLIGHT
--------------------------------------------------------------------------------
local JA_Users_List = {}
local API_URL = "https://jacommunity.squareweb.app/users"

local function ApplyJAHighlight(player)
    if player == LocalPlayer then return end
    
    local function AddVisuals(char)
        if not char then return end
        if char:FindFirstChild("JA_Highlight") then char.JA_Highlight:Destroy() end
        if char:FindFirstChild("JA_Tag") then char.JA_Tag:Destroy() end
        
        local hl = Instance.new("Highlight")
        hl.Name = "JA_Highlight"
        hl.FillColor = Color3.fromRGB(0, 150, 255)
        hl.OutlineColor = Color3.fromRGB(255, 255, 255)
        hl.FillTransparency = 0.5
        hl.OutlineTransparency = 0
        hl.Adornee = char
        hl.Parent = char
        
        local bb = Instance.new("BillboardGui")
        bb.Name = "JA_Tag"
        bb.Size = UDim2.new(0, 100, 0, 50)
        bb.StudsOffset = Vector3.new(0, 3.5, 0)
        bb.AlwaysOnTop = true
        bb.Parent = char
        
        local txt = Instance.new("TextLabel", bb)
        txt.Text = "J/A USER"
        txt.BackgroundTransparency = 1
        txt.TextColor3 = Color3.fromRGB(0, 255, 255)
        txt.TextStrokeTransparency = 0
        txt.Font = Enum.Font.GothamBlack
        txt.TextSize = 14
        txt.Size = UDim2.new(1,0,1,0)
    end

    if player.Character then AddVisuals(player.Character) end
    player.CharacterAdded:Connect(AddVisuals)
end

task.spawn(function()
    local success, response = pcall(function()
        return request_func({Url = API_URL, Method = "GET"})
    end)

    if success and response.StatusCode == 200 then
        local data = HttpService:JSONDecode(response.Body)
        JA_Users_List = data.users or {}
        
        local isRegistered = false
        for _, name in pairs(JA_Users_List) do
            if name == LocalPlayer.Name then isRegistered = true; break end
        end
        
        if not isRegistered then
            pcall(function()
                request_func({
                    Url = API_URL,
                    Method = "POST",
                    Headers = {["Content-Type"] = "application/json"},
                    Body = HttpService:JSONEncode({username = LocalPlayer.Name})
                })
            end)
            table.insert(JA_Users_List, LocalPlayer.Name)
        end
        
        for _, plr in pairs(Players:GetPlayers()) do
            if table.find(JA_Users_List, plr.Name) then ApplyJAHighlight(plr) end
        end
        
        Players.PlayerAdded:Connect(function(plr)
            if table.find(JA_Users_List, plr.Name) then ApplyJAHighlight(plr) end
        end)
    end
end)

--------------------------------------------------------------------------------
-- 5. SETTINGS
--------------------------------------------------------------------------------

local SETTINGS = {
    AutoJoin = false,
    AutoError = true,
    SpeedBoost = false,
    SpamCount = 5,
    MinGenRaw = "10",
    MinGenVal = 10,
    Blacklist = {},
    Priority = {},
    LastJobId = ""
}

local function SaveConfig()
    if writefile then
        local dataToSave = {
            AutoError = SETTINGS.AutoError,
            SpeedBoost = SETTINGS.SpeedBoost,
            SpamCount = SETTINGS.SpamCount,
            MinGenRaw = SETTINGS.MinGenRaw,
            Blacklist = SETTINGS.Blacklist,
            Priority = SETTINGS.Priority
        }
        writefile(CONFIG_FILE, HttpService:JSONEncode(dataToSave))
    end
end

local function LoadConfig()
    if isfile and isfile(CONFIG_FILE) then
        local success, result = pcall(function()
            return HttpService:JSONDecode(readfile(CONFIG_FILE))
        end)
        if success and result then
            if result.AutoError ~= nil then SETTINGS.AutoError = result.AutoError end
            if result.SpeedBoost ~= nil then SETTINGS.SpeedBoost = result.SpeedBoost end
            if result.SpamCount ~= nil then SETTINGS.SpamCount = result.SpamCount end
            if result.MinGenRaw ~= nil then 
                SETTINGS.MinGenRaw = result.MinGenRaw
                SETTINGS.MinGenVal = GetGenValue(result.MinGenRaw)
            end
            if result.Blacklist ~= nil then SETTINGS.Blacklist = result.Blacklist end
            if result.Priority ~= nil then SETTINGS.Priority = result.Priority end
        end
    end
    SETTINGS.AutoJoin = false 
end
LoadConfig()

local function IsBlacklisted(name)
    if not name then return false end
    for _, v in pairs(SETTINGS.Blacklist) do
        if v:lower() == name:lower() then return true end
    end
    return false
end

local function IsPriority(name)
    if not name then return false end
    for _, v in pairs(SETTINGS.Priority) do
        if v:lower() == name:lower() then return true end
    end
    return false
end

local function PlayPrioritySound()
    local sound = Instance.new("Sound")
    sound.SoundId = "rbxassetid://4590657391"
    sound.Volume = 10
    sound.Parent = CoreGui
    sound.PlayOnRemove = true
    sound:Destroy()
end

--------------------------------------------------------------------------------
-- 6. UI ENGINE
--------------------------------------------------------------------------------

local Colors = {
    Bg = Color3.fromRGB(18, 18, 22),
    Item = Color3.fromRGB(28, 28, 33),
    Accent = Color3.fromRGB(0, 110, 255),
    Text = Color3.fromRGB(255, 255, 255),
    SubText = Color3.fromRGB(160, 160, 170),
    Green = Color3.fromRGB(50, 200, 100),
    Red = Color3.fromRGB(255, 60, 60),
    Gold = Color3.fromRGB(255, 215, 0)
}

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "JA_UltimateUI"
ScreenGui.Parent = gethui and gethui() or CoreGui
ScreenGui.ResetOnSpawn = false

local function Corner(p, r)
    local c = Instance.new("UICorner"); c.CornerRadius = UDim.new(0, r); c.Parent = p; return c
end

local function Stroke(p, c, t)
    local s = Instance.new("UIStroke"); s.Color = c; s.Thickness = t or 1; s.Parent = p; return s
end

local function EnableDrag(frame)
    local dragging, dragInput, dragStart, startPos
    local function Update(input)
        local delta = input.Position - dragStart
        frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
    frame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true; dragStart = input.Position; startPos = frame.Position
            input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then dragging = false end end)
        end
    end)
    frame.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then dragInput = input end
    end)
    UserInputService.InputChanged:Connect(function(input) if input == dragInput and dragging then Update(input) end end)
end

-- FLOATING BUTTON
local FloatBtn = Instance.new("TextButton", ScreenGui)
FloatBtn.Name = "Toggle"
FloatBtn.Size = UDim2.new(0, 50, 0, 50)
FloatBtn.Position = UDim2.new(0, 20, 0.5, -25) 
FloatBtn.BackgroundColor3 = Colors.Item
FloatBtn.Text = "J/A"
FloatBtn.TextColor3 = Colors.Text
FloatBtn.Font = Enum.Font.GothamBlack
FloatBtn.TextSize = 16
FloatBtn.AutoButtonColor = true
Corner(FloatBtn, 25) 
Stroke(FloatBtn, Colors.Accent, 2)
EnableDrag(FloatBtn)

-- Main Frame
local Main = Instance.new("Frame", ScreenGui)
Main.Size = UDim2.new(0, 360, 0, 270)
Main.Position = UDim2.new(0.5, -180, 0.5, -135)
Main.BackgroundColor3 = Colors.Bg
Main.ClipsDescendants = true
Corner(Main, 8)
Stroke(Main, Color3.fromRGB(50, 50, 55), 1.5)
EnableDrag(Main)

FloatBtn.MouseButton1Click:Connect(function() Main.Visible = not Main.Visible end)

-- Header
local Title = Instance.new("TextLabel", Main)
Title.Text = "J/A <font color='#808080'>JOINER</font>"
Title.RichText = true
Title.Size = UDim2.new(1, -60, 0, 30)
Title.Position = UDim2.new(0, 10, 0, 0)
Title.BackgroundTransparency = 1
Title.Font = Enum.Font.GothamBlack
Title.TextSize = 13
Title.TextColor3 = Colors.Text
Title.TextXAlignment = Enum.TextXAlignment.Left

local StatusDot = Instance.new("Frame", Main)
StatusDot.Size = UDim2.new(0, 6, 0, 6)
StatusDot.Position = UDim2.new(1, -12, 0, 12)
StatusDot.BackgroundColor3 = Colors.Red
Corner(StatusDot, 6)

-- Zones
local LeftZone = Instance.new("Frame", Main)
LeftZone.Size = UDim2.new(0.6, -5, 1, -35)
LeftZone.Position = UDim2.new(0, 5, 0, 30)
LeftZone.BackgroundColor3 = Colors.Item
Corner(LeftZone, 4)

local RightZone = Instance.new("Frame", Main)
RightZone.Size = UDim2.new(0.4, -10, 1, -35)
RightZone.Position = UDim2.new(0.6, 5, 0, 30)
RightZone.BackgroundColor3 = Colors.Item
Corner(RightZone, 4)

-- Logs
local Scroll = Instance.new("ScrollingFrame", LeftZone)
Scroll.Size = UDim2.new(1, -6, 1, -6)
Scroll.Position = UDim2.new(0, 3, 0, 3)
Scroll.BackgroundTransparency = 1
Scroll.ScrollBarThickness = 2
Scroll.ScrollBarImageColor3 = Colors.Accent
local ListLayout = Instance.new("UIListLayout", Scroll)
ListLayout.Padding = UDim.new(0, 4)
ListLayout.SortOrder = Enum.SortOrder.LayoutOrder

-- Settings Layout
local RightLayout = Instance.new("UIListLayout", RightZone)
RightLayout.Padding = UDim.new(0, 5)
RightLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
local RightPad = Instance.new("UIPadding", RightZone)
RightPad.PaddingTop = UDim.new(0, 5)

-- ELEMENTS
local function MakeToggle(name, settingKey, callback)
    local initialState = SETTINGS[settingKey]
    local F = Instance.new("Frame", RightZone)
    F.Size = UDim2.new(0, 120, 0, 20)
    F.BackgroundTransparency = 1
    
    local L = Instance.new("TextLabel", F)
    L.Text = name
    L.Size = UDim2.new(1, -40, 1, 0)
    L.BackgroundTransparency = 1
    L.TextColor3 = Colors.SubText
    L.Font = Enum.Font.GothamBold
    L.TextSize = 10
    L.TextXAlignment = Enum.TextXAlignment.Left

    local Btn = Instance.new("TextButton", F)
    Btn.Size = UDim2.new(0, 32, 0, 16)
    Btn.AnchorPoint = Vector2.new(1, 0.5)
    Btn.Position = UDim2.new(1, 0, 0.5, 0)
    Btn.BackgroundColor3 = initialState and Colors.Accent or Color3.fromRGB(50,50,55)
    Btn.Text = ""
    Corner(Btn, 10)
    
    local Circle = Instance.new("Frame", Btn)
    Circle.Size = UDim2.new(0, 12, 0, 12)
    Circle.Position = initialState and UDim2.new(1, -14, 0.5, -6) or UDim2.new(0, 2, 0.5, -6)
    Circle.BackgroundColor3 = Colors.Text
    Corner(Circle, 10)

    Btn.MouseButton1Click:Connect(function()
        local s = not (Btn.BackgroundColor3 == Colors.Accent)
        local tPos = s and UDim2.new(1, -14, 0.5, -6) or UDim2.new(0, 2, 0.5, -6)
        local tCol = s and Colors.Accent or Color3.fromRGB(50,50,55)
        TweenService:Create(Circle, TweenInfo.new(0.2), {Position = tPos}):Play()
        TweenService:Create(Btn, TweenInfo.new(0.2), {BackgroundColor3 = tCol}):Play()
        callback(s)
        if settingKey ~= "AutoJoin" then SaveConfig() end
    end)
end

local function MakeInput(name, def, callback)
    local F = Instance.new("Frame", RightZone)
    F.Size = UDim2.new(0, 120, 0, 30)
    F.BackgroundTransparency = 1
    local L = Instance.new("TextLabel", F)
    L.Text = name; L.Size = UDim2.new(1,0,0,12); L.BackgroundTransparency=1; L.TextColor3=Colors.SubText; L.Font=Enum.Font.Gotham; L.TextSize=9; L.TextXAlignment=0
    local Box = Instance.new("TextBox", F)
    Box.Size = UDim2.new(1,0,0,16); Box.Position=UDim2.new(0,0,0,12); Box.BackgroundColor3=Colors.Bg; Box.Text=def; Box.TextColor3=Colors.Accent; Box.Font=Enum.Font.GothamBold; Box.TextSize=10
    Corner(Box, 4)
    Box.FocusLost:Connect(function() callback(Box.Text); SaveConfig() end)
end

MakeToggle("Auto Join", "AutoJoin", function(v) SETTINGS.AutoJoin = v end)
MakeToggle("Auto Error", "AutoError", function(v) SETTINGS.AutoError = v end)
MakeToggle("Speed Boost", "SpeedBoost", function(v) SETTINGS.SpeedBoost = v end)
MakeInput("Spam Amount", tostring(SETTINGS.SpamCount), function(v) SETTINGS.SpamCount = tonumber(v) or 5 end)
MakeInput("Min Gen", SETTINGS.MinGenRaw, function(v) SETTINGS.MinGenRaw = v; SETTINGS.MinGenVal = GetGenValue(v) end)

-- Buttons Row
local BtnRow = Instance.new("Frame", RightZone)
BtnRow.Size = UDim2.new(0, 120, 0, 20)
BtnRow.BackgroundTransparency = 1

local OpenBL = Instance.new("TextButton", BtnRow)
OpenBL.Size = UDim2.new(0, 58, 1, 0)
OpenBL.BackgroundColor3 = Colors.Bg
OpenBL.Text = "Blacklist"
OpenBL.TextColor3 = Colors.Red
OpenBL.Font = Enum.Font.GothamBold
OpenBL.TextSize = 9
Corner(OpenBL, 4)

local OpenPrio = Instance.new("TextButton", BtnRow)
OpenPrio.Size = UDim2.new(0, 58, 1, 0)
OpenPrio.Position = UDim2.new(0, 62, 0, 0)
OpenPrio.BackgroundColor3 = Colors.Bg
OpenPrio.Text = "Priority"
OpenPrio.TextColor3 = Colors.Gold
OpenPrio.Font = Enum.Font.GothamBold
OpenPrio.TextSize = 9
Corner(OpenPrio, 4)

-- OVERLAY
local Overlay = Instance.new("Frame", Main)
Overlay.Size = UDim2.new(1, 0, 1, 0)
Overlay.BackgroundColor3 = Colors.Bg
Overlay.Visible = false
Overlay.ZIndex = 10
Corner(Overlay, 8)

local OvTitle = Instance.new("TextLabel", Overlay)
OvTitle.Size = UDim2.new(1, 0, 0, 30)
OvTitle.BackgroundTransparency = 1
OvTitle.TextColor3 = Colors.Text
OvTitle.Font = Enum.Font.GothamBlack
OvTitle.TextSize = 12
OvTitle.ZIndex = 11

local OvBack = Instance.new("TextButton", Overlay)
OvBack.Text = "< Back"
OvBack.Size = UDim2.new(0, 50, 0, 30)
OvBack.BackgroundTransparency = 1
OvBack.TextColor3 = Colors.Accent
OvBack.Font = Enum.Font.GothamBold
OvBack.TextSize = 11
OvBack.ZIndex = 11
OvBack.MouseButton1Click:Connect(function() Overlay.Visible = false end)

local OvInp = Instance.new("TextBox", Overlay)
OvInp.Size = UDim2.new(0, 140, 0, 24)
OvInp.Position = UDim2.new(0, 10, 0, 35)
OvInp.BackgroundColor3 = Colors.Item
OvInp.PlaceholderText = "Add name..."
OvInp.TextColor3 = Colors.Text
OvInp.Font = Enum.Font.Gotham
OvInp.TextSize = 11
OvInp.ZIndex = 11
Corner(OvInp, 4)

local OvAdd = Instance.new("TextButton", Overlay)
OvAdd.Size = UDim2.new(0, 30, 0, 24)
OvAdd.Position = UDim2.new(0, 155, 0, 35)
OvAdd.BackgroundColor3 = Colors.Green
OvAdd.Text = "+"
OvAdd.TextColor3 = Colors.Item
OvAdd.Font = Enum.Font.GothamBold
OvAdd.ZIndex = 11
Corner(OvAdd, 4)

local OvScroll = Instance.new("ScrollingFrame", Overlay)
OvScroll.Size = UDim2.new(1, -20, 1, -70)
OvScroll.Position = UDim2.new(0, 10, 0, 65)
OvScroll.BackgroundTransparency = 1
OvScroll.ZIndex = 11
local OvLayout = Instance.new("UIListLayout", OvScroll); OvLayout.Padding = UDim.new(0, 4)

local CurrentListType = "Blacklist"

local function RefreshOverlay()
    for _,v in pairs(OvScroll:GetChildren()) do if v:IsA("Frame") then v:Destroy() end end
    local targetTable = (CurrentListType == "Blacklist") and SETTINGS.Blacklist or SETTINGS.Priority
    for i, name in pairs(targetTable) do
        local F = Instance.new("Frame", OvScroll)
        F.Size = UDim2.new(1, 0, 0, 22)
        F.BackgroundColor3 = Colors.Item
        F.ZIndex = 11
        Corner(F, 3)
        local L = Instance.new("TextLabel", F)
        L.Text = name
        L.Size = UDim2.new(1, -25, 1, 0)
        L.Position = UDim2.new(0, 5, 0, 0)
        L.BackgroundTransparency = 1
        L.TextColor3 = (CurrentListType == "Blacklist") and Colors.Red or Colors.Gold
        L.Font = Enum.Font.Gotham
        L.TextSize = 10
        L.TextXAlignment = Enum.TextXAlignment.Left
        L.ZIndex = 11
        local Del = Instance.new("TextButton", F)
        Del.Text = "x"
        Del.Size = UDim2.new(0, 22, 1, 0)
        Del.Position = UDim2.new(1, -22, 0, 0)
        Del.BackgroundTransparency = 1
        Del.TextColor3 = Colors.Red
        Del.ZIndex = 11
        Del.MouseButton1Click:Connect(function()
            table.remove(targetTable, i)
            SaveConfig()
            RefreshOverlay()
        end)
    end
end

OpenBL.MouseButton1Click:Connect(function() 
    CurrentListType = "Blacklist"; OvTitle.Text = "BLACKLIST"; OvTitle.TextColor3 = Colors.Red; Overlay.Visible = true; RefreshOverlay() 
end)
OpenPrio.MouseButton1Click:Connect(function() 
    CurrentListType = "Priority"; OvTitle.Text = "PRIORITY"; OvTitle.TextColor3 = Colors.Gold; Overlay.Visible = true; RefreshOverlay() 
end)

OvAdd.MouseButton1Click:Connect(function()
    if OvInp.Text ~= "" then
        local targetTable = (CurrentListType == "Blacklist") and SETTINGS.Blacklist or SETTINGS.Priority
        table.insert(targetTable, OvInp.Text)
        OvInp.Text = ""
        SaveConfig()
        RefreshOverlay()
    end
end)

--------------------------------------------------------------------------------
-- 7. LOGIC
--------------------------------------------------------------------------------

local function Teleport(jobId, count)
    task.spawn(function()
        for i=1, (count or 1) do
            TeleportService:TeleportToPlaceInstance(game.PlaceId, jobId, LocalPlayer)
            if count > 1 then task.wait(0.5) end
        end
    end)
end

local function AddLog(name, gen, jobId)
    local isPrio = IsPriority(name)
    local Row = Instance.new("Frame", Scroll)
    Row.Size = UDim2.new(1, 0, 0, 26)
    Row.BackgroundColor3 = Colors.Bg
    Corner(Row, 3)
    if isPrio then Stroke(Row, Colors.Gold, 1); PlayPrioritySound() end
    local Txt = Instance.new("TextLabel", Row)
    Txt.Text = name .. " <font color='#808080'>|</font> " .. gen
    Txt.RichText = true
    Txt.Size = UDim2.new(1, -55, 1, 0)
    Txt.Position = UDim2.new(0, 4, 0, 0)
    Txt.BackgroundTransparency = 1
    Txt.TextColor3 = isPrio and Colors.Gold or Colors.Text
    Txt.Font = Enum.Font.GothamBold
    Txt.TextSize = 10
    Txt.TextXAlignment = Enum.TextXAlignment.Left
    local BJ = Instance.new("TextButton", Row)
    BJ.Text = "J"
    BJ.Size = UDim2.new(0, 22, 0, 18)
    BJ.Position = UDim2.new(1, -50, 0.5, -9)
    BJ.BackgroundColor3 = Colors.Accent
    BJ.TextColor3 = Colors.Text
    BJ.Font = Enum.Font.GothamBold
    BJ.TextSize = 9
    Corner(BJ, 3)
    local BS = Instance.new("TextButton", Row)
    BS.Text = "S"
    BS.Size = UDim2.new(0, 22, 0, 18)
    BS.Position = UDim2.new(1, -24, 0.5, -9)
    BS.BackgroundColor3 = Colors.Red
    BS.TextColor3 = Colors.Text
    BS.Font = Enum.Font.GothamBold
    BS.TextSize = 9
    Corner(BS, 3)
    BJ.MouseButton1Click:Connect(function() Teleport(jobId, 1) end)
    BS.MouseButton1Click:Connect(function() Teleport(jobId, SETTINGS.SpamCount) end)
    if #Scroll:GetChildren() > 20 then
        local c = Scroll:GetChildren()
        for i=1, #c do if c[i]:IsA("Frame") then c[i]:Destroy(); break end end
    end
end

RunService.Heartbeat:Connect(function()
    if SETTINGS.SpeedBoost then
        local char = LocalPlayer.Character
        if char then
            local root = char:FindFirstChild("HumanoidRootPart")
            local hum = char:FindFirstChild("Humanoid")
            if root and hum and hum.MoveDirection.Magnitude > 0 then
                root.AssemblyLinearVelocity = Vector3.new(hum.MoveDirection.X * 30, root.AssemblyLinearVelocity.Y, hum.MoveDirection.Z * 30)
            end
        end
    end
end)

task.spawn(function()
    while true do
        task.wait(1)
        if SETTINGS.AutoError then pcall(function() GuiService:ClearError() end) end
    end
end)

task.spawn(function()
    local failCount = 0
    while true do
        if StatusDot.BackgroundColor3 ~= Colors.Green then
            StatusDot.BackgroundColor3 = Colors.Red
            local sig = GenerateSignature()
            local url = string.format("wss://jacommunity.squareweb.app/?token=%s&sig=%s", SafeKey, sig)
            local s, ws = pcall(function() return ConnectWS(url) end)
            if s and ws then
                StatusDot.BackgroundColor3 = Colors.Green
                failCount = 0
                ws.OnMessage:Connect(function(msg)
                    local ok, d = pcall(function() return HttpService:JSONDecode(msg) end)
                    if ok and d and d.data and d.data.animal then
                        local ani = d.data.animal
                        if not IsBlacklisted(ani.name) then
                            if GetGenValue(ani.generation) >= SETTINGS.MinGenVal then
                                if d.data.jobId ~= SETTINGS.LastJobId then
                                    SETTINGS.LastJobId = d.data.jobId
                                    task.spawn(function() AddLog(ani.name, ani.generation, d.data.jobId) end)
                                    if SETTINGS.AutoJoin then Teleport(d.data.jobId, 1) end
                                end
                            end
                        end
                    end
                end)
                ws.OnClose:Connect(function() StatusDot.BackgroundColor3 = Colors.Red end)
                repeat task.wait(1) until StatusDot.BackgroundColor3 == Colors.Red
            else
                failCount = failCount + 1
                task.wait(2 + failCount)
            end
        end
        task.wait(1)
    end
end)